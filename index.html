<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setting Schedule Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #1e3a5f;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 8px;
            font-size: 14px;
        }

        select, input[type="file"] {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: #4db8a8;
        }

        .upload-area {
            border: 2px dashed #4db8a8;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f9fffe;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f0fffe;
            border-color: #3da799;
        }

        .upload-area.dragover {
            background: #e6fffc;
            border-color: #2d9688;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #4db8a8;
            color: white;
        }

        .btn-primary:hover {
            background: #3da799;
        }

        .btn-secondary {
            background: #1e3a5f;
            color: white;
        }

        .btn-secondary:hover {
            background: #152a45;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #preview {
            margin-top: 30px;
            display: none;
        }

        .schedule-page {
            background: white;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid #ddd;
            position: relative;
            min-height: 1400px;
        }

        .schedule-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 1;
            z-index: 0;
        }

        .schedule-content {
            position: relative;
            z-index: 1;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: #4db8a8;
            border-radius: 50%;
        }

        .brand {
            font-weight: 700;
            color: #1e3a5f;
            font-size: 18px;
        }

        .schedule-title {
            text-align: right;
        }

        .schedule-title h2 {
            color: #1e3a5f;
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .date-range {
            color: #1e3a5f;
            font-size: 20px;
        }

        .section-title {
            color: #4db8a8;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .schedule-table th {
            background: #1e3a5f;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        .schedule-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        .schedule-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .schedule-table tbody tr:nth-child(odd) {
            background: white;
        }

        .footer-note {
            margin-top: 20px;
            font-size: 11px;
            color: #666;
            font-style: italic;
        }

        @media print {
			@page {
				size: auto; /* Use the paper size selected by the user */
				margin: 0;  /* Set all margins to zero */
			}

			/* Hide all the UI elements inside the main container, EXCEPT the preview area */
			body > .container > *:not(#preview) {
				display: none;
			}

			/* Reset body and container for a clean, edgeless print layout */
			body, .container {
				background: white;
				padding: 0;
				margin: 0;
				box-shadow: none;
				border: none;
			}

			/* Ensure the preview container is visible and takes up the full space */
			#preview {
				display: block !important;
				margin: 0;
				padding: 0;
			}

			/* Style the wrapper DIV for each generated canvas */
			#preview > div {
				margin: 0;
				border: none;
			}

			/* Make the canvas image itself fill the width of the page */
			#preview canvas {
				width: 100%;
				height: auto;
				box-shadow: none;
				border: none;
			}
		}

        .error {
            background: #fee;
            border: 1px solid #fcc;
            padding: 15px;
            border-radius: 4px;
            color: #c33;
            margin-top: 20px;
        }

        .info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            padding: 15px;
            border-radius: 4px;
            color: #0050b3;
            margin-top: 20px;
        }
		
		/* --- STYLES FOR THE INSTRUCTIONS MODAL --- */
		.modal-overlay {
			display: none; /* Hidden by default */
			position: fixed; /* Stay in place */
			z-index: 1000; /* Sit on top of everything */
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto; /* Enable scroll if needed */
			background-color: rgba(0,0,0,0.6); /* Black background with opacity */
		}

		.modal-content {
			background-color: #fefefe;
			margin: 10% auto; /* 10% from the top and centered */
			padding: 40px;
			border: 1px solid #888;
			width: 80%;
			max-width: 700px;
			border-radius: 8px;
			position: relative;
		}

		.modal-content h2 {
			margin-top: 0;
			color: #1e3a5f;
		}

		.modal-content ol, .modal-content ul {
			margin-left: 20px;
		}
		 .modal-content li {
			margin-bottom: 10px;
		}

		.modal-close {
			color: #aaa;
			position: absolute;
			top: 15px;
			right: 25px;
			font-size: 28px;
			font-weight: bold;
		}

		.modal-close:hover,
		.modal-close:focus {
			color: black;
			text-decoration: none;
			cursor: pointer;
		}
    </style>
</head>
<body>
    <div class="container">
        <h1>Setting Schedule Generator</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="gym-select">Select Gym Location</label>
                <select id="gym-select">
                    <option value="">-- Choose Gym --</option>
                    <option value="DSN">Design (DSN)</option>
                    <option value="PLN">Plano (PLN)</option>
                    <option value="DTN">Denton (DTN)</option>
                    <option value="FTW">Fort Worth (FTW)</option>
                    <option value="GVN">Grapevine (GVN)</option>
                    <option value="HIL">Hillcrest (HIL)</option>
                </select>
            </div>
        </div>

        <div class="upload-area" id="upload-area">
            <p style="margin-bottom: 10px; font-weight: 600; color: #1e3a5f;">Upload Humanity CSV</p>
            <p style="font-size: 14px; color: #666;">Drag & drop or click to browse</p>
            <input type="file" id="csv-input" accept=".csv" style="display: none;">
        </div>

        <div class="buttons">
            <button class="btn-primary" id="generate-btn" disabled>Generate Schedule</button>

            <button class="btn-secondary" id="download-btn" disabled>Download Image</button>
            <button class="btn-secondary" id="print-btn" disabled>Print / Save PDF</button>
			
			<button class="btn-secondary" id="help-btn">Instructions</button>
        </div>

        <div id="messages"></div>
        <div id="preview"></div>
    </div>

    <script src="walls.js"></script>
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
	document.addEventListener('DOMContentLoaded', function() {
        let csvData = null;
        let selectedGym = '';

        // Map dropdown codes to actual gym names in Humanity CSV
        const gymNameMap = {
            'DSN': 'Design',
            'PLN': 'Plano',
            'DTN': 'Denton',
            'FTW': 'Fort Worth',
            'GVN': 'Grapevine',
            'HIL': 'Dallas Hill'  // or just "Hill"?
        };

        const uploadArea = document.getElementById('upload-area');
        const csvInput = document.getElementById('csv-input');
        const gymSelect = document.getElementById('gym-select');
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const printBtn = document.getElementById('print-btn');
        const messages = document.getElementById('messages');
        const preview = document.getElementById('preview');
		const helpBtn = document.getElementById('help-btn');
		const modalOverlay = document.getElementById('help-modal-overlay');
		const modalCloseBtn = document.getElementById('modal-close-btn');

        // Upload area interactions
        uploadArea.addEventListener('click', () => csvInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        csvInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        gymSelect.addEventListener('change', (e) => {
            selectedGym = e.target.value;
            checkReady();
        });

        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showMessage('Please upload a CSV file', 'error');
                return;
            }

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    csvData = results.data;
                    showMessage(`CSV loaded successfully (${csvData.length} rows)`, 'info');
                    checkReady();
                },
                error: (error) => {
                    showMessage(`Error parsing CSV: ${error.message}`, 'error');
                }
            });
        }

        function checkReady() {
            if (csvData && selectedGym) {
                generateBtn.disabled = false;
            }
        }

        function showMessage(msg, type) {
            messages.innerHTML = `<div class="${type}">${msg}</div>`;
        }

        generateBtn.addEventListener('click', generateSchedule);
		downloadBtn.addEventListener('click', downloadImages);
        printBtn.addEventListener('click', () => window.print());
		
		// --- ADD THESE THREE LISTENERS ---
		helpBtn.addEventListener('click', () => {
			modalOverlay.style.display = 'block';
		});

		modalCloseBtn.addEventListener('click', () => {
			modalOverlay.style.display = 'none';
		});

		// Close the modal if the user clicks anywhere on the gray overlay
		window.addEventListener('click', (event) => {
			if (event.target == modalOverlay) {
				modalOverlay.style.display = 'none';
			}
		});
		
		function initializeState() {
			selectedGym = gymSelect.value;
			checkReady();
		}
		
		function expandWallRanges(titleStr) {
			// Regex to find all patterns like "B1-2", "C3-5", etc.
			const rangeRegex = /([a-zA-Z]+)(\d+)-(\d+)/g;
    
			return titleStr.replace(rangeRegex, (match, prefix, startStr, endStr) => {
				const start = parseInt(startStr);
				const end = parseInt(endStr);
				const expanded = [];
				for (let i = start; i <= end; i++) {
					expanded.push(prefix + i);
				}
				return expanded.join(', '); // Turns "B1-2" into "B1, B2"
			});
		}

        function parseWalls(titleStr, gym) {
			if (!titleStr || !gymWalls[gym]) return [];

			const currentGymWalls = gymWalls[gym];
			const expandedTitle = expandWallRanges(titleStr);
    
			let cleanTitle = expandedTitle.toLowerCase().replace('jcca - ', '');
			
			const parts = cleanTitle.replace(/\./g, '').split(/[,\/\s+]+/g).filter(s => s);
			const walls = [];
			let buffer = [];

			for (const part of parts) {
				buffer.push(part);
				const potentialWall = buffer.join(' ');

				if (currentGymWalls[potentialWall]) {
					walls.push(potentialWall);
					buffer = [];
					continue;
				}
			}
    
			for(const part of buffer){
				if(currentGymWalls[part]){
					walls.push(part);
				}
			}

			return [...new Set(walls)];
		}

        function getClimbType(walls, gym) {
			if (walls.length === 0 || !gymWalls[gym]) return '-';
    
			const types = walls.map(w => gymWalls[gym][w]?.climb_type).filter(t => t);
			if (types.length === 0) return '-';

			// Count occurrences
			const counts = {};
			types.forEach(t => counts[t] = (counts[t] || 0) + 1);

			// Return most common
			return Object.keys(counts).sort((a, b) => counts[b] - counts[a])[0];
		}

        function getWallType(walls, gym) {
			if (walls.length === 0 || !gymWalls[gym]) return null;
			return gymWalls[gym][walls[0]]?.type;
		}

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        function generateSchedule() {
			// --- START: NEW GYM DETECTION LOGIC ---

			// 1. Pre-scan the CSV to detect the most likely gym.
			const gymCounts = {};
			const gymCodes = Object.keys(gymNameMap); // ['DSN', 'PLN', ...]

			csvData.forEach(row => {
				const location = (row['Location'] || '').trim();
				if (location) {
					for (const code of gymCodes) {
						if (location.includes(gymNameMap[code])) {
							gymCounts[code] = (gymCounts[code] || 0) + 1;
							break; // Stop after finding the first match for this row
						}
					}
				}
			});

			// 2. Determine the detected gym (the one with the most mentions).
			let detectedGym = null;
			if (Object.keys(gymCounts).length > 0) {
				detectedGym = Object.keys(gymCounts).sort((a, b) => gymCounts[b] - gymCounts[a])[0];
			}

			// 3. If a gym was detected and it doesn't match the user's selection, prompt them.
			if (detectedGym && detectedGym !== selectedGym) {
				const selectedGymFullName = gymNameMap[selectedGym] || selectedGym;
				const detectedGymFullName = gymNameMap[detectedGym] || detectedGym;
				
				const message = `${selectedGymFullName} was selected, but the CSV data appears to be for ${detectedGymFullName}.\n\nWould you like to switch to ${detectedGymFullName} and generate the schedule?`;

				if (confirm(message)) {
					// If user clicks "OK", switch the gym and re-run.
					gymSelect.value = detectedGym;
					selectedGym = detectedGym;
					generateSchedule(); // Re-run the function with the correct gym
					return; // Stop the current execution
				} else {
					// If user clicks "Cancel", just stop.
					return;
				}
			}
			
			// --- END: NEW GYM DETECTION LOGIC ---


			// --- Core data processing logic (remains the same) ---
			const scheduleByDate = {};

			csvData.forEach((row, index) => {
				const date = row['Start Date'];
				const title = row['Title'];
				const location = (row['Location'] || '').trim();

				// This check is now a fallback, as we've already mostly verified the gym.
				if (!date || !title || !location.includes(gymNameMap[selectedGym])) {
					return;
				}

				const skipTitles = ['admin', 'personal training', 'washing', 'forerunning', 'climb time', '@hill', '@design', '@plano', '@dtn', '@ftw'];
				if (skipTitles.some(skip => title.toLowerCase().includes(skip))) {
					return;
				}

				const walls = parseWalls(title, selectedGym);
				if (walls.length === 0) {
					console.log(`Row ${index}: Skipped - no valid walls found in "${title}" for gym ${selectedGym}`);
					return;
				}
				
				const names = (row['Employee Names'] || '').split('/').map(n => n.trim()).filter(n => n);
				const setterCount = names.length;

				if (!scheduleByDate[date]) {
					scheduleByDate[date] = { date: new Date(date), walls: [], setterCount: 0 };
				}

				scheduleByDate[date].walls.push(...walls);
				scheduleByDate[date].setterCount += setterCount;
			});

			const scheduleData = Object.values(scheduleByDate).map(day => {
				const uniqueWalls = [...new Set(day.walls)];
				return {
					date: day.date,
					dateStr: formatDate(day.date),
					location: uniqueWalls.join(', '),
					climbType: getClimbType(uniqueWalls, selectedGym),
					setterCount: day.setterCount
				};
			});

			scheduleData.sort((a, b) => a.date - b.date);

			if (scheduleData.length === 0) {
				// This message will now only show if the CSV is for the right gym but has no valid setting entries.
				showMessage('No valid setting schedule data found for the selected gym in this CSV.', 'error');
				return;
			}

			// ... the rest of the function continues as before ...
			const startSunday = new Date(scheduleData[0].date);
			startSunday.setDate(startSunday.getDate() - startSunday.getDay());

			const endSaturday = new Date(startSunday);
			endSaturday.setDate(endSaturday.getDate() + 13);

			const dateRange = `${formatDate(startSunday)}-${formatDate(endSaturday)}`;
			window.scheduleStartSunday = startSunday;

			const scheduleByDay = Array(14).fill(null).map(() => ({ routes: [], boulders: [] }));
			scheduleData.forEach(item => {
				const daysSinceStart = Math.floor((item.date - startSunday) / (1000 * 60 * 60 * 24));
				if (daysSinceStart >= 0 && daysSinceStart < 14) {
					 const dayData = { ...item };
					 const walls = parseWalls(item.location, selectedGym);

					 const ropeWalls = walls.filter(w => gymWalls[selectedGym][w]?.type === 'rope');
					 const boulderWalls = walls.filter(w => gymWalls[selectedGym][w]?.type === 'boulder');

					 if(ropeWalls.length > 0){
						 scheduleByDay[daysSinceStart].routes.push({
							 ...dayData,
							 location: ropeWalls.join(', '),
							 climbType: getClimbType(ropeWalls, selectedGym)
						 });
					 }
					 if(boulderWalls.length > 0){
						 scheduleByDay[daysSinceStart].boulders.push({
							 ...dayData,
							 location: boulderWalls.join(', '),
							 climbType: getClimbType(boulderWalls, selectedGym)
						 });
					 }
				}
			});

			const hasRoutes = scheduleByDay.some(day => day.routes.length > 0);
			const hasBoulders = scheduleByDay.some(day => day.boulders.length > 0);

			if (!hasRoutes && !hasBoulders) {
				showMessage('No schedule data found for selected gym', 'error');
				return;
			}

			renderToCanvas(scheduleByDay, dateRange, hasRoutes, hasBoulders);
		}

        async function renderToCanvas(scheduleByDay, dateRange, hasRoutes, hasBoulders) {
			preview.innerHTML = '';
			const canvases = [];

			// --- START: NEW, SMARTER ROUTER LOGIC ---

			// Case 1: Handle Combined Gyms (GVN, PLN)
			if (selectedGym === 'GVN' || selectedGym === 'PLN') {
				// These gyms have one combined page. Render it if there is ANY data.
				if (hasRoutes || hasBoulders) {
					// We pass 'routes' as a placeholder type; the renderPage function knows to
					// look for the 'combined' coordinates for these gyms.
					const canvas = await renderPage('routes', scheduleByDay, dateRange);
					canvases.push({ canvas, name: `${selectedGym}_schedule.png` });
				}
			}
			
			// Case 2: Handle Boulders-Only Gyms (HIL, DTN, FTW)
			else if (selectedGym === 'HIL' || selectedGym === 'DTN' || selectedGym === 'FTW') {
				// These gyms have one page, and only if there is boulder data.
				if (hasBoulders) {
					const canvas = await renderPage('boulders', scheduleByDay, dateRange);
					canvases.push({ canvas, name: `${selectedGym}_boulders_schedule.png` });
				}
			}
			
			// Case 3: Handle Split-Page Gyms (DSN)
			else {
				// This is the default behavior for gyms with separate pages.
				if (hasRoutes) {
					const canvas = await renderPage('routes', scheduleByDay, dateRange);
					canvases.push({ canvas, name: `${selectedGym}_routes_schedule.png` });
				}
				if (hasBoulders) {
					const canvas = await renderPage('boulders', scheduleByDay, dateRange);
					canvases.push({ canvas, name: `${selectedGym}_boulders_schedule.png` });
				}
			}

			// Display canvases (this part remains the same)
			canvases.forEach(({ canvas, name }) => {
				const container = document.createElement('div');
				container.style.marginBottom = '20px';
				canvas.style.maxWidth = '100%';
				canvas.style.height = 'auto';
				canvas.style.border = '1px solid #ddd';
				container.appendChild(canvas);
				preview.appendChild(container);
			});

			preview.style.display = 'block';
			downloadBtn.disabled = false;
			printBtn.disabled = false;

			window.generatedCanvases = canvases;
			showMessage('Schedule generated successfully!', 'info');
		}

        async function renderPage(type, scheduleByDay, dateRange) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                canvas.width = 791;
                canvas.height = 1024;
                const ctx = canvas.getContext('2d');

                // Determine the correct template file name
                let templateFile;
                if (selectedGym === 'GVN') {
                    // GVN has only one combined page
                    templateFile = `templates/${selectedGym}_routes.png`;
                } else if (selectedGym === 'HIL' || selectedGym === 'DTN' || selectedGym === 'FTW') {
                    // Boulder-only gyms
                    templateFile = `templates/${selectedGym}_boulders.png`;
                } else {
                    // DSN and PLN have separate routes/boulders
                    templateFile = `templates/${selectedGym}_${type}.png`;
                }

                // Load background image
                const img = new Image();
                img.onload = () => {
                    // Draw background
                    ctx.drawImage(img, 0, 0, 791, 1024);

                    //Render the date range header
                    // 1. Get coordinates for this gym/type FIRST
                    const gymCoords = templateCoords[selectedGym];
                    if (!gymCoords) {
                        console.error(`No coordinates found for ${selectedGym}`);
                        resolve(canvas);
                        return;
                    }

                    // Determine which coordinate set to use
					let coords;
					if (selectedGym === 'GVN' || selectedGym === 'PLN') {
						coords = gymCoords['combined']; // Use 'combined' for GVN and PLN
					} else {
						coords = gymCoords[type]; // Use 'routes' or 'boulders' for all other gyms
					}

                    if (!coords) {
                        console.error(`No coordinates found for ${selectedGym} ${type}`);
                        resolve(canvas);
                        return;
                    }

                    // 2. NOW that 'coords' exists, we can render the header
                    if (coords.header) {
                        ctx.font = 'bold 24px Montserrat, Arial, sans-serif';
                        ctx.fillStyle = '#1e3a5f';
                        ctx.textAlign = 'right';
                        ctx.fillText(dateRange, coords.header.x, coords.header.y);
                        ctx.textAlign = 'left';
                    }

                    // 3. Continue with the rest of the rendering
                    ctx.fillStyle = '#1e3a5f';
                    ctx.font = '14px Montserrat, Arial, sans-serif';
                    ctx.textBaseline = 'middle';

                    // Render left table (week 1)
                    const week1 = scheduleByDay.slice(0, 7);
                    renderTableData(ctx, week1, type, coords.leftTable, coords.tableTop, coords.rowHeight, 0);

                    // Render right table (week 2)
                    const week2 = scheduleByDay.slice(7, 14);
                    renderTableData(ctx, week2, type, coords.rightTable, coords.tableTop, coords.rowHeight, 7);

                    resolve(canvas);
                };
                img.onerror = reject;
                img.src = templateFile;
            });
        }

        function renderTableData(ctx, weekData, type, tableCoords, tableTop, rowHeight, weekOffset) {
            const startSunday = window.scheduleStartSunday;

            weekData.forEach((day, rowIndex) => {
                const y = tableTop + (rowIndex * rowHeight);
             
				let items = day[type] || []; // Default behavior for other gyms
    
				// If it's the combined GVN/PLN schedule, merge boulders and routes together
				if (selectedGym === 'GVN' || selectedGym === 'PLN') {
					const routes = day.routes || [];
					const boulders = day.boulders || [];
					items = routes.concat(boulders);
				}

				
                const currentDate = new Date(startSunday);
                currentDate.setDate(currentDate.getDate() + weekOffset + rowIndex);
                const dateStr = formatDate(currentDate);

                if (items.length > 0) {
                    const locations = items.map(i => i.location).join(', ');
					const capitalizedLocations = capitalizeWallNames(locations);
                    const climbType = items[0].climbType;
                    const setterCount = items.reduce((total, item) => total + item.setterCount, 0);

                    // Draw date
                    ctx.fillText(dateStr, tableCoords.date.x, y);
                    
                    // Draw location (truncate if too long)
                    const truncatedLocation = truncateText(ctx, capitalizedLocations, tableCoords.location.width);
                    ctx.fillText(truncatedLocation, tableCoords.location.x, y);
                    
                    // Draw climb type
                    ctx.fillText(climbType, tableCoords.climbType.x, y);
                    
                    // Draw setter count
                    ctx.fillText(String(setterCount), tableCoords.setters.x, y);
                } else {
                    // Draw empty row with date
                    ctx.fillText(dateStr, tableCoords.date.x, y);
                    ctx.fillText('-', tableCoords.location.x, y);
                    ctx.fillText('-', tableCoords.climbType.x, y);
                    ctx.fillText('-', tableCoords.setters.x, y);
                }
            });
        }

        function truncateText(ctx, text, maxWidth) {
            if (ctx.measureText(text).width <= maxWidth) {
                return text;
            }
            
            let truncated = text;
            while (ctx.measureText(truncated + '...').width > maxWidth && truncated.length > 0) {
                truncated = truncated.slice(0, -1);
            }
            return truncated + '...';
        }
		
		function capitalizeWallNames(text) {
			if (!text) return '';

			// Split the full string by ", " to get each individual wall name
			return text.split(', ').map(wallName => {
				// Split each wall name by " " to get the words
				return wallName.split(' ').map(word => {
					// Capitalize the first letter of each word and add the rest
					return word.charAt(0).toUpperCase() + word.slice(1);
				}).join(' '); // Join the words back together with spaces
			}).join(', '); // Join the wall names back together with ", "
		}

        function downloadImages() {
            if (!window.generatedCanvases) return;

            window.generatedCanvases.forEach(({ canvas, name }) => {
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = name;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            });
        }
		initializeState();
	});	
    </script>
<!-- ======================= -->
<!--     INSTRUCTIONS MODAL    -->
<!-- ======================= -->
<div id="help-modal-overlay" class="modal-overlay">
    <div class="modal-content">
        <span id="modal-close-btn" class="modal-close">&times;</span>
        <h2>How to Use the Schedule Generator</h2>
        <ol>
            <li>
                <strong>Export from Humanity:</strong> In Humanity, go to the "Schedule" tab and export the desired two-week period as a CSV file. (Tools > Export Schedule)
            </li>
            <li>
                <strong>Select Gym:</strong> Choose your gym location from the dropdown menu.
            </li>
            <li>
                <strong>Upload CSV:</strong> Drag and drop the exported CSV file onto the upload area, or click to browse and select it.
            </li>
            <li>
                <strong>Generate:</strong> Click the "Generate Schedule" button. The tool will process the file and display a preview of the schedule image(s).
            </li>
            <li>
                <strong>Download or Print:</strong>
                <ul>
                    <li>Click <strong>"Download Image"</strong> to save the schedule(s) as PNG files, perfect for posting online and using in emails.</li>
                    <li>Click <strong>"Print / Save PDF"</strong> to open a print-friendly version, which you can print directly or save as a clean PDF for in-gym display.</li>
                </ul>
            </li>
        </ol>
        <p style="font-size: 12px; color: #666; margin-top: 20px;">
            <strong>Troubleshooting:</strong> If the wrong gym is detected, the tool will ask you to confirm before proceeding. If schedule data seems to be missing, ensure the 'Title' column in the CSV contains valid wall names.
        </p>
    </div>
</div>
</body>
</html>
